version: 2.1

setup: true

orbs:
  path-filtering: circleci/path-filtering@0.0.2
  continuation: circleci/continuation@0.1.2
  circleci-cli: circleci/circleci-cli@0.1.9

executors:
  base:
    docker:
      - image: cimg/base:stable

jobs:
  run_some_checks:
    executor: base
    steps:
      - checkout

  prepare_for_next:
    executor: path-filtering/default
    steps:
      - checkout
      - 
      - circleci-cli/install
      - path-filtering/set-parameters:
          base-revision: << pipeline.git.base_revision >>
          mapping: |
            front/.* build-front true
            back/.* build-back true
      - run: cat /tmp/pipeline-parameters.json
      - run:
          name: Set Version
          command: |
            echo "version: 2.1" >> continue-config.yml
      - run:
          name: Create Config
          command: |
            circleci config pack .circleci/primary >> continue-config.yml
      - run:
          name: Validate Config
          command: |
            circleci config validate continue-config.yml
      - path-filtering/set-parameters
      - run:
          name: Set resource class setting
          command: |
            import json

            branch = '<< pipeline.git.branch >>'
            param_path = '/tmp/pipeline-parameters.json'
            with open(param_path, 'r') as param_file:
              params = json.load(param_file)
            if branch == 'main':
              resource_size = 'large'
            else:
              resource_size = 'small'
            params.update({'default-resource-class': resource_size, 'resource_size': 'small', 'last_one': 'test'})
            with open(param_path, 'w') as fp: 
                fp.write(json.dumps(params))
          shell: /usr/bin/env python3
      - run: cat /tmp/pipeline-parameters.json

      - continuation/continue:
          configuration_path: ./continue-config.yml

workflows:
  setup-workflow:
    jobs:
      - run_some_checks
      - prepare_for_next:
          requires:
            - run_some_checks
